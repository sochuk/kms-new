function setMessageCount(t) { var e = 0, n = $("#__menu_message").find("span.count-indicator .count"), a = $("#__side_message").find("span.count-indicator .count"), o = $("#__menu_message, #__side_message"); if (0 === n.length && 0 !== t.message.message_unread_count ? $(o).append('<span id="count" class="count-indicator"><span class="count">' + t.message.message_unread_count + "</span></span>") : (e = parseInt($(n).text()) + 1, $(n).text(e), $(a).text(e)), null !== t.message.message_unread_userdata) t.message.message_unread_userdata.forEach(function (t, e) { var n = $('ul.chat-list li span[data-username="' + t.username + '"]').closest("li").find("span.count-indicator .count"), a = $('ul.chat-list li span[data-username="' + t.username + '"]').closest("li"); if (0 === n.length) $(a).append('<span id="count" class="count-indicator"><span class="count">' + t.unread + "</span></span>"), $(a).trigger("change"); else { var o = parseInt($(n).text()) + 1; $(n).text(o).trigger("change") } }); else { var s = $('ul.chat-list li span[data-username="' + t.message.user.username + '"]').closest("li").find("span.count-indicator .count"), i = $('ul.chat-list li span[data-username="' + t.message.user.username + '"]').closest("li"); if (0 === s.length) $(i).append('<span id="count" class="count-indicator"><span class="count">1</span></span>'); else { var c = parseInt($(s).text()) + 1; $(s).text(c) } } setTotalCount() } function notifyMessage(t) { window.location.href.toLowerCase() !== host + "/account/message" && ($.notify({ heading: '<i class="fa fa-comment mr-2"></i> ' + t.message.user.fullname, text: '<a href="' + host + '/account/message">You have ' + $("a#__menu_message #count .count").text() + " unread message</a>", loader: !1, hideAfter: 3e5, stack: 5, position: "bottom-right" }), document.hasFocus() || (parent.focus(), window.focus())) } function setNotificationCount(t) { var e = 0, n = $("#__menu_notification").find("span.count-indicator .count"), a = $("#__side_notification").find("span.count-indicator .count"), o = $("#__menu_notification, #__side_notification"); 0 === n.length && 0 !== t.notification.unread ? $(o).append('<span id="count" class="count-indicator"><span class="count">' + t.notification.unread + "</span></span>") : (e = parseInt($(n).text()) + 1, $(n).text(e), $(a).text(e)), setTotalCount() } function notifyNotification(t) { window.location.href.toLowerCase() !== host + "/account/notification" && ($.notify({ heading: '<i class="mdi mdi-bell mr-2"></i> ' + t.user.fullname, text: '<a href="' + host + '/account/notification">You have ' + $("a#__menu_notification #count .count").text() + " unread notification</a>", loader: !1, hideAfter: 3e5, stack: 5, position: "bottom-right" }), document.hasFocus() || (parent.focus(), window.focus())) } function setTotalCount() { var t = $("#__side_total").find("span.count-indicator .count"), e = $("#__side_total"), n = isNaN(parseInt($("#__menu_notification .count-indicator").text())) ? 0 : parseInt($("#__menu_notification .count-indicator").text()), a = isNaN(parseInt($("#__menu_message .count-indicator").text())) ? 0 : parseInt($("#__menu_message .count-indicator").text()); 0 === t.length ? ($(e).append('<span id="count" class="count-indicator"><span class="count">' + (n + a) + "</span></span>"), $(e).trigger("change")) : (count = parseInt(n + a), $(t).text(count)) } function duplicateLogin(t, e) { $("body").removeClass("loaded").addClass("loader"), $("body").find(".loader").fadeOut().remove(), $.notify({ heading: t, text: e, allowToastClose: !1, hideAfter: !1, position: "top-center" }), $("button#useHere").on("click", function (t) { t.preventDefault(), hub.server.logoutAnother() }), $("button#logout").on("click", function (t) { t.preventDefault(), duplicateSignout() }) } function duplicateSignout() { clearQ(), window.location.replace(host + "/account/logout") } function setQ(t, e, n) { Cookies.set(qw, t), Cookies.set(er, e), Cookies.set(ty, n) } function clearQ() { Cookies.remove(qw), Cookies.remove(er), Cookies.remove(ty) } function scrollMessageEnd() { var t = $("#__message_container"); $(t).length > 0 && $(t).stop().animate({ scrollTop: $(t)[0].scrollHeight }, 0) } $(function () { let t = $.connection.defaultHub; var e = !1, n = "0c9e12731c3cd6df7de64d798a62afc8"; t.client.getBroadcastMessage = function (t, e) { var n = $("<div />").text(t).html(), a = $("<div />").text(e).html(); $("#discussion").append("<li><strong>" + n + "</strong>:&nbsp;&nbsp;" + a + "</li>") }, t.client.getDuplicateLogin = function (t, e, n) { t !== $.connection.defaultHub.state.local_ipaddress && (setQ(!0, $("<div />").text(e).html(), $("<div />").text(n).html()), duplicateLogin(e, n)) }, t.client.logoutAnother = function (t) { t !== $.connection.defaultHub.state.local_ipaddress ? duplicateSignout() : (clearQ(), $(".notify").remove(), $("body").removeClass("loader").addClass("loaded")) }, t.client.getMessage = function (t) { var e = $("<div />").text(t.message.user.fullname).html(), n = $("<div />").text(t.message.message_content).html(); e === $.connection.defaultHub.state.fullname ? $("div#__message_container").append('<div class="d-flex justify-content-end px-4 py-1 position-relative"><span class="bg-lightgreen px-3 py-2 rounded">' + n + '<span class="small ml-5 text-muted" style="right:10px;bottom:2px;">' + t.message.message_date + "</span></span></div>") : ($("div#__message_container").append('<div class="d-flex justify-content-start px-4 py-1 position-relative"><span class="bg-lightblue px-3 py-2 rounded">' + n + '<span class="small ml-5 text-muted" style="right:10px;bottom:2px;">' + t.message.message_date + "</span></span></div>"), setMessageCount(t)), scrollMessageEnd(), notifyMessage(t) }, t.client.getNotification = function (t) { setNotificationCount(t), notifyNotification(t) }, $.connection.hub.start(function () { $.get("https://www.cloudflare.com/cdn-cgi/trace", function (e) { var n = e.split("\n"), a = new Object; n.forEach(function (t, e) { var n = t.split("="); a[n[0]] = n[1] }), t.server.join(a.ip, a.uag).done(function (e) { $("button#send_message").click(function () { $("textarea#message").val().trim().length > 0 && t.server.sendTo($("div#__user_target span").attr("data-id"), $("div#__user_target span").attr("data-username"), $("textarea#message").val()), $("textarea#message").val("").focus() }), setMessageCount(e), setNotificationCount(e), setTotalCount(e) }) }) }), $.connection.hub.disconnected(function () { setTimeout(function () { $.connection.hub.start(), Pace.restart() }, 5e3) }), $.connection.hub.reconnecting(function () { e = !0 }), $.connection.hub.reconnected(function () { e = !1, Pace.restart() }), $.connection.hub.disconnected(function () { e && console.log("Trying reconnecting...") }), $(document).ready(function () { void 0 === Cookies.get(n) && !0 !== Cookies.get(n) || duplicateLogin($("<div/>").html(Cookies.get("21ae63a5d0d4bdcdc1f9a07b3456ba7d")).text(), $("<div/>").html(Cookies.get("52d0c2d4b65c5e9650a4a1d088e1c36e")).text()); $("span.count").on("change", function () { var t = isNaN(parseInt($(this).text())) ? 0 : parseInt($(this).text()); console.log("change event"), t <= 0 ? $(this).closest(".count-indicator").fadeOut() : $(this).closest(".count-indicator").fadeIn() }) }) });